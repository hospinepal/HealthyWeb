' Gambas class file

Private $sType As String
Private $ImgList As String[]

Public Sub _new(encid As String, sType As String)

  txtencid.Text = encid
  $sType = sType

  If txtencid.Text Then
    btnshow_Click()
  Else
    pnlfirst.Visible = True
  Endif

End

Public Sub btnwebcam_Click()

  txtencid.Text = QRScanValue("")
  If txtencid.Text Then
    btnshow_Click()
  Endif

End

Public Sub btnshow_Click()

  If txtencid.Text Then
    If txtencid.Text = modBasic.$EncIdPrefix Then
    Else
      modSettings.SaveValuesToLog("LastValue/Encounter", Trim(txtencid.Text))
    Endif
    txtpatientname.Text = modPatient.GetPatientNameByEnc(Trim(txtencid.Text))
    modSettings.ShowCheckBox(chkmultiple, "ScannerSetting/PDFSave")
    $ImgList = New String[]
  Endif

End

Public Sub chkmultiple_Click()

  modSettings.EnterCheckSetting(chkmultiple, "ScannerSetting/PDFSave")

End

Public Sub btnload_Click()

  btnload.Upload()

End

Public Sub btnload_Progress()

  WebProgressBar1.Value = btnload.Progress

End

Public Sub btnload_Finish()

  Dim xPath As String

  xPath = modPrint.GetCopyTempPath(btnload.Path)
  Me.Exec("Toastify({text: 'Upload Completed', duration: 3000}).showToast()")
  If xPath Then
    modImage.StretchtPictureToBox(PictureBox1, xPath)
    txtpath.Text = xPath
    If chkmultiple.Value = True Then
      $ImgList.Add(txtpath.Text)
    Endif
    txtdetail.Text = $sType & ":" & modString.GetDateString(Now())
  Endif

End

Public Sub btnload_Abort(Reason As String)

  Message.Error("Unable to upload file.<br>Reason: " & Html(Reason))
  WebProgressBar1.Value = 0

End

''No Scanner in web application
' ' Public Sub btnscanner_Click()
' '
' '   txtpath.Text = ScannedFile()
' '   Wait
' '   If Exist(txtpath.Text) Then
' '     PictureBox1.Image = modPrint.GetFileWebURL(txtpath.Text)
' '     txtdetail.Text = modString.GetNowString()
' '     If chkmultiple.Value = True Then
' '       $ImgList.Add(txtpath.Text)
' '     Endif
' '   Endif
' '
' ' End

Public Sub btnupload_Click()

  Dim hForm As FmFTPUpload
  Dim xPath As String

  If chkmultiple.Value = True Then
    xPath = modDevAll.ComvertMultiImagesToPDF($ImgList)
  Else
    xPath = txtpath.Text
  Endif
  If Exist(xPath) Then
    hForm = New FmFTPUpload(xPath)
    hForm.ShowModal
  Endif

End

Public Sub btnsaveimg_Click()

  Dim sPath As String
  Dim sLongID As Long

  If chkmultiple.Value = True Then
    sPath = modDevAll.ComvertMultiImagesToPDF($ImgList)
  Else
    sPath = txtpath.Text
  Endif
  If Exist(sPath) Then
    sLongID = modImage.SavePatientFileGeneral(Trim(txtencid.Text), $sType, txtdetail.Text, sPath, False)    ''
    Me.Exec("Toastify({text: 'Information saved', duration: 3000}).showToast()")
  Else
    Message.Warning("Unable to upload", ("OK"))
  Endif

End

Public Sub btnclose_Click()

  Me.Close()

End
