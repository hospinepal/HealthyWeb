' Gambas class file

Private dtfir As Date
Private dtlast As Date
Private $location As String
Private $Value As String

Public Sub _new()

  $location = modDataRepo.$RepositoryMode
  $Value = modBasic.$HospCode
  cmbchartmode.List = ["bar", "pie"]
  dtselect.Value = Now()
  If modSettings.ShowSettingFromFIle("Dashboard/AutoChart") = "Yes" Then
    btnshow_Click()
  Endif

End

Public Sub btnshow_Click()

  WebContainer3.Visible = True
  dtfir = dtselect.Value
  dtlast = dtselect.Value

  ShowChartOne()
  ShowChartTwo()
  ShowChartThree()
  ShowChartFour()
  ShowChartFive()
  ShowChartSix()

End

Private Sub ShowChartOne()

  Dim grpList As String[]
  Dim xFinal As Variant[]
  Dim xWebCanv As WebCanvas

  grpList = modControlSub.GetDirectFillresult(modDatabase.$syConn.Exec("select distinct(fldconsultname) as col from tblconsult where fldconsulttime>=&1 and fldconsulttime<=&2 and fldconsultname like &3 and fldstatus<>&4" & modDataRepo.GetWhereStringRepo($location, $Value), modDate.StartSqlDate(dtfir), modDate.EndSqlDate(dtlast), "%", "Cancelled"))
  If grpList Then
    grpList.Sort()
    xFinal = modDashBoard.GetConsultationReportDash(grpList, dtfir, dtlast, $location, $Value, "%")

    If wbcontone.Children.Count Then
      wbcontone.DeleteChildren()
    Endif
    xWebCanv = New WebCanvas(wbcontone)
    xWebCanv.Expand = True
    CreateChartImage(cmbchartmode.Text, "Consultation", 4, xFinal, xWebCanv)
  Endif

End

Private Sub ShowChartTwo()

  Dim grpList As String[]
  Dim xFinal As Variant[]
  Dim xWebCanv As WebCanvas

  grpList = modControlSub.GetDirectFillresult(modDatabase.$syConn.Exec("select distinct(fldconsultname) as col from tblopvisit where fldconsulttime>=&1 and fldconsulttime<=&2 and fldconsultname like &3 and fldstatus<>&4" & modDataRepo.GetWhereStringRepo($location, $Value), modDate.StartSqlDate(dtfir), modDate.EndSqlDate(dtlast), "%", "Cancelled"))
  If grpList Then
    grpList.Sort()
    xFinal = modDashBoard.GetOPVisitReportDash(grpList, dtfir, dtlast, $location, $Value, "")

    If wbconttwo.Children.Count Then
      wbconttwo.DeleteChildren()
    Endif
    xWebCanv = New WebCanvas(wbconttwo)
    xWebCanv.Expand = True
    CreateChartImage(cmbchartmode.Text, "OP Visits", 4, xFinal, xWebCanv)
  Endif

End

Private Sub ShowChartThree()

  Dim depList As String[]
  Dim xFinal As Variant[]
  Dim xWebCanv As WebCanvas

  depList = ["Discharged", "LAMA", "Refer", "Death", "Absconder"]
  If depList Then
    xFinal = modDashBoard.GetInPatientReportDash(depList, "%", dtfir, dtlast, $location, $Value, "Exits(All)")

    If wbcontthree.Children.Count Then
      wbcontthree.DeleteChildren()
    Endif
    xWebCanv = New WebCanvas(wbcontthree)
    xWebCanv.Expand = True
    CreateChartImage(cmbchartmode.Text, "Discharge Outcomes", 3, xFinal, xWebCanv)
  Endif

End

Private Sub ShowChartFour()

  Dim xFinal As Variant[]
  Dim delTyList As String[]
  Dim xWebCanv As WebCanvas

  delTyList = modControlSub.GetDirectFillresultNoNull(modDatabase.$syConn.Exec("select distinct(flddeltype) as col from tblconfinement where flddeltime>=&1 and flddeltime<=&2" & modDataRepo.GetWhereStringRepo($location, $Value), modDate.StartSqlDate(dtfir), modDate.EndSqlDate(dtlast)))
  If delTyList Then
    xFinal = modDashBoard.GetConfinementReportDash(delTyList, dtfir, dtlast, $location, $Value)

    If wbcontfour.Children.Count Then
      wbcontfour.DeleteChildren()
    Endif
    xWebCanv = New WebCanvas(wbcontfour)
    xWebCanv.Expand = True
    CreateChartImage(cmbchartmode.Text, "Delivery Report", 4, xFinal, xWebCanv)
  Endif

End

Private Sub ShowChartFive()

  Dim depList As String[]
  Dim xFinal As Variant[]
  Dim xWebCanv As WebCanvas

  depList = modMedicine.GetPathoCategoryList("Test")
  If depList Then
    xFinal = modDashBoard.GetDiagnosticReportDash(depList, dtfir, dtlast, $location, $Value, "Diagnostic Tests")

    If wbcontfive.Children.Count Then
      wbcontfive.DeleteChildren()
    Endif
    xWebCanv = New WebCanvas(wbcontfive)
    xWebCanv.Expand = True
    CreateChartImage(cmbchartmode.Text, "Diagnostic Tests", 1, xFinal, xWebCanv)
  Endif

End

Private Sub ShowChartSix()

  Dim depList As String[]
  Dim xFinal As Variant[]
  Dim xWebCanv As WebCanvas

  depList = modMedicine.GetPathoCategoryList("Radio")
  If depList Then
    xFinal = modDashBoard.GetDiagnosticReportDash(depList, dtfir, dtlast, $location, $Value, "Radio Diagnostics")

    If wbcontsix.Children.Count Then
      wbcontsix.DeleteChildren()
    Endif
    xWebCanv = New WebCanvas(wbcontsix)
    xWebCanv.Expand = True
    CreateChartImage(cmbchartmode.Text, "Radio Diagnostics", 3, xFinal, xWebCanv)
  Endif

End

Private Sub CreateChartImage(sType As String, sTitle As String, Column As Integer, xFinal As Variant[], xWebCanvas As WebCanvas)

  Dim xValues As Variant[]
  Dim yValues As Variant[]
  Dim sColl As Collection
  Dim xChart As Collection
  Dim sPath As String

  xValues = New Variant[]
  yValues = New Variant[]
  For Each sColl In xFinal
    If sColl["0"] = "Total" Then
    Else
      xValues.Add(sColl["0"])
      yValues.Add(CFloat(sColl[Column]))
    Endif
  Next
  xChart = modChartJS.GetHTMLChartScript(sType, sTitle, xValues, yValues)
  sPath = "new Chart(\"" & xWebCanvas.Name & "\", " & JSON.Encode(xChart) & ")"
  Me.Exec(sPath)

End
